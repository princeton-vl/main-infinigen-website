---
sidebar_label: "Getting Started"
sidebar_position: 1
---

# Tutorial Intro

# Procgen

Procedurally generated datasets.

![image](https://user-images.githubusercontent.com/5783450/210371169-e177b46c-fa56-4cfe-8056-685b41b550af.png)

## Setup

First, we create a new python env with necessary dependencies

```
conda create --name procgen python=3.10
conda activate procgen
```

If not on IONIC, install necessary apt dependencies:

```
sudo apt-get install libglm-dev libglew-dev libglfw3-dev libgles2-mesa-dev zlib1g-dev
```

Finally, run the install script

```
bash install.sh
```

If you want to run with CUDA, compile on a CUDA machine.

### Manual Compilation

If the above didnt work for you, or you wish to rebuild part of the project, below are instructions for manually compiling the terrain-related C++ code

```
cd /worldgen/terrain/cpp_utils
# on linux including ionic
blender-3.1.2-linux-x64/3.1/python/bin/python3.10 setup_linux.py build_ext --inplace
# or the following on Mac
CC="${HOMEBREW_PREFIX}/opt/llvm/bin/clang++" /path/to/Blender.app/Contents/Resources/3.1/python/bin/python3.10 setup_macos.py build_ext --inplace
```

## Contributing

### Rules

- This project is developed against python3.10.x, blender 3.1.2. You must use these versions.
- `install.sh` must always set up the project from scratch
  - If you make changes that require additional packages, you must modify requirements.txt and commit it alongside the changes.
  - If your code needs compiling, it must happen when install.sh is run
- If you use any tutorials, resources or external code, you must document them in the spreadsheet pinned on slack
- For each feature you work on, make an appropriately named branch.
- When a feature is "finished", run ~20 renders on IONIC to test it, then make a Pull Request
- Code style
  - Use 4 spaces indentation
  - No 'from X import \*'
  - Avoid sys.path.append except in driver scripts directly run by blender

### Running single scenes

To get started, do the following to generate a coarse terrain:

```
cd worldgen
../blender/blender --background -noaudio --python generate.py -- --seed 0 --task coarse --output_folder outputs/dev/coarse
```

This will produce a file at `outputs/dev/coarse/scene.blend`, which you can inspect in blender.

"desert" can be other gin files.

Then, on a machine with a display, open the produced blender file to inspect results:
`blender outputs/dev/scene.blend`

After this, do the following to generate a fine terrain based on camera views:

```
../blender/blender --background -noaudio --python generate.py -- --seed 0 --task populate fine_terrain --input_folder outputs/dev/coarse --output_folder outputs/dev/fine
```

"main.frames" can be any frame in the blend file
if you want to subdivide multi view, which may be useful for video, set, e.g., 'main.frames = [1, 2]'

### Setting up paths

It is best practice to have the pipeline put its output in /n/fs/scratch. For your convinience, you may want to do these symlinks:

```
cd worldgen
mkdir -p /n/fs/scratch/$USER/procgen_outputs
ln -s /n/fs/scratch/$USER/procgen_outputs outputs
ln -s /n/fs/scratch/$USER/procgen_outputs /n/fs/pvl-progen/www/$USER/outputs_scratch
```

Finally, you will need to let infinigen know where to find it's bank of pre-generated assets. If you are on IONIC, you can add
`export INFINIGEN_ASSET_FOLDER=/n/fs/pvl-progen/terrain-assets/` to your bashrc. If you dont want to use pre-generated assets, and are okay with slow runtime, do `export INFINIGEN_ASSET_FOLDER=''`. Otherwise, you must download the relevant versions yourself. You must make sure that this folder contains a copy of the version of the assets currently specified in config/base.gin's `asset_version` field.

### Data Generation Examples

##### Render batches of images on SLURM for visualization

```
python -m tools.manage_datagen_jobs --output_folder outputs/myjob --num_scenes 200 --pipeline_configs pvl stereo --cleanup big_files
```

to use gpu (high_quality_terrain in configs to make more use of gpu)

```
python -m tools.manage_datagen_jobs --configs high_quality_terrain --output_folder outputs/myjob --num_scenes 200 --pipeline_configs pvl enable_gpu stereo --cleanup big_files
```

##### Render stereo pairs at large scale on SLURM, with auto upload and cleanup

```
python -m tools.manage_datagen_jobs --output_folder outputs/myjob --num_scenes 50000 --pipeline_configs pvl stereo --warmup_sec 3000 --cleanup all --upload
```

In single frame case, add `-p SphericalMesher.complete_depth_test=0` to above two commands to skip dense pixel wise complete depth test

##### Render videos on a desktop workstation

```
python -m tools.manage_datagen_jobs --output_folder outputs/myjob --num_scenes 50 --pipeline_configs local_64GB monocular_video --cleanup big_files
```

In most of the above commands we assume you are on a slurm cluster. If you want to run locally, replace `pvl` with `desktop` or `desktop_small` (for 256GB or 128GB ram workstations), or make your own tools/pipeline_config file and configure compute as you see fit. If you want something other than stereo/video, replace `stereo`/`stereo_video` with `monocular` or `monocular_flow` or some other option from `tools/pipeline_configs`. Note that the pipeline config can only affect what jobs are run (ie how many cameras, how many timesteps), not what those jobs produce. IE, if you want particular passes to be output, you will need to specify that with a `--config` option not a `--pipeline_config`

We use wandb to log stats. If you dont want to deal with this, add `--wandb_mode disabled` to any of the above commands. If you are in PVL, send your username to Alex Raistrick to be added to our wandb group.

## Creating asset grid figures

```
../blender/blender --background -noaudio --python tools/asset_grid.py -- -f CarnivoreFactory -n 10 -r 1024x1024 -s 500 --gpu
```

## Counting Lines of Code

```
pygount --suffix=gin,py --folders-to-skip dependencies --format summary
```

## Generating Assets

Remember to recompile for sake of reproducibleness.

To pre-generate assets locally:

```
../blender/blender --background -noaudio --python tools/generate_terrain_assets.py -- -f ~/render/assets/May27
```

To pre-generate assets on a SLURM cluster

```
python tools/submit_terrain_assets.py -b ../blender/blender -f "/n/fs/pvl-progen/terrain-assets/FOLDER" -s 0 -e NUMBER

```

Replace FOLDER and NUMBER as you need.

## Setting up desktop ssh access

```
sudo apt-get install openssh-server
sudo systemctl enable ssh --now
```

Now do `hostname -I` and add the result to Alex's Lab Logistics spreadsheet. The IP may change when you reboot, which will require you to repeat this step. Ideally, avoid rebooting the PC.

## Check for files with no Copyright statement

```
grep --include \*.py --include \*.cpp --include \*.h -riL "Copyright" worldgen
```
